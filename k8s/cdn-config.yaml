apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-cdn-config
data:
  nginx.conf: |
    upstream superlink_backend {
        server superlink-service:80;
    }
    
    server {
        listen 80;
        server_name superlink.zm;
        
        # Enable compression
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
        
        # Enable Brotli compression
        brotli on;
        brotli_comp_level 6;
        brotli_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
        
        # Static assets with long cache
        location /_next/static/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Cache-Status "HIT";
        }
        
        # Images with medium cache
        location /images/ {
            expires 7d;
            add_header Cache-Control "public";
            add_header X-Cache-Status "HIT";
        }
        
        # API routes with short cache
        location /api/ {
            expires 5m;
            add_header Cache-Control "public, max-age=300";
            proxy_pass http://superlink_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Default location
        location / {
            expires 1h;
            add_header Cache-Control "public, max-age=3600";
            proxy_pass http://superlink_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
